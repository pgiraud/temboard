{% extends ../../../templates/base.html %}

{% block title %}[{{instance.hostname}}:{{instance.pg_port}}] - Slow Queries{% end %}

{% block content %}
<div class="mb-2">
  <a class="btn btn-primary" href="/server/{{instance.agent_address}}/{{instance.agent_port}}/slowqueries/settings">Settings</a>
</div>
<div id="app">
  <table class="table table-query table-sm small">
    <thead>
      <th>
        username
      </th>
      <th>
        appname
      </th>
      <th>
        dbname
      </th>
      <th>
        ntuples
      </th>
      <th>
        datetime
      </th>
      <th>
        temp_blks_written
      </th>
      <th>
        hitratio
      </th>
      <th class="text-right">
        duration
      </th>
      <th>
        query
      </th>
    </thead>
    <tbody>
      <tr v-for="query in slowQueries" v-on:click="explain(query)">
        <td>
          {{!query.username}}
        </td>
        <td>
          {{!query.appname}}
        </td>
        <td>
          {{!query.dbname}}
        </td>
        <td>
          {{!query.ntuples}}
        </td>
        <td>
          {{!moment(query.datetime).format()}}<br>
        </td>
        <td>
          {{!query.temp_blks_written}}
        </td>
        <td>
          {{!query.hitratio}}
        </td>
        <td class="text-right">
          {{!moment.duration(query.duration).format("w[w] d[d] h[h] m[m] s[s] SSS[ms]", { largest: 2 })}}
        </td>
        <td class="query" width="50%">
          <pre><code class="sql">{{! query.query }}</code></pre>
        </td>
      </tr>
    </tbody>
  </table>
  <div id="explainModal" class="modal modal-fullscreen" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Explained Execution Plan</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body d-flex flex-column p-0">
          <template v-if="plan">
            <pg-explain :plan-raw="plan" :plan-query="sql" :key="explainKey"></pg-explain>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>
<link href="/css/slowqueries/pgExplain.css" rel="stylesheet">
<script src="/js/moment.min.js"></script>
<script src="/js/moment-duration-format.js"></script>
<script src="/js/vue.min.js"></script>
<script src="/js/highlightjs/highlight.pack.js"></script>
<script src="/js/slowqueries/temboard.slowqueries.js"></script>
<script src="/js/slowqueries/pgExplain.umd.js"></script>
<script>
  var apiUrl = '/proxy/{{ instance.agent_address }}/{{ instance.agent_port }}/slowqueries';
</script>
{% end %}
