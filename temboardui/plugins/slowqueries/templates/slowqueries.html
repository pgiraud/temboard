{% extends ../../../templates/base.html %}

{% block title %}[{{instance.hostname}}:{{instance.pg_port}}] - Slow Queries{% end %}

{% block content %}
<div id="app">
  <div class="row form-group mb-2">
    <div class="col-12 d-flex justify-content-between">
      <a class="btn btn-primary" href="/server/{{instance.agent_address}}/{{instance.agent_port}}/slowqueries/settings">Settings</a>
      <daterangepicker :from="from" :to="to" v-on:update="onPickerUpdate"></daterangepicker>
    </div>
  </div>
  <table class="table table-query table-sm small">
    <thead>
      <th>
        username
      </th>
      <th>
        appname
      </th>
      <th>
        dbname
      </th>
      <th class="text-right">
        ntuples
      </th>
      <th>
        datetime
      </th>
      <th title="temp_blks_written" class="text-right">
        tbw
      </th>
      <th class="text-right">
        hitratio
      </th>
      <th class="text-right">
        duration
      </th>
      <th>
        query
      </th>
      <th></th>
      <th></th>
    </thead>
    <tbody>
      <tr v-for="query in slowQueries">
        <td>
          {{!query.username}}
        </td>
        <td>
          {{!query.appname}}
        </td>
        <td>
          {{!query.dbname}}
        </td>
        <td class="text-right">
          {{!query.ntuples}}
        </td>
        <td>
          {{!moment(query.datetime).format()}}<br>
        </td>
        <td class="text-right">
          {{!query.temp_blks_written}}
        </td>
        <td class="text-right">
          {{!query.hitratio}}
        </td>
        <td class="text-right">
          {{!moment.duration(query.duration).format("w[w] d[d] h[h] m[m] s[s] SSS[ms]", { largest: 2 })}}
        </td>
        <td class="query" width="50%" data-toggle="popover" data-trigger="hover" >
          <pre><code class="sql">{{! query.query }}</code></pre>
        </td>
        <td>
          <a v-on:click.prevent="explain(query)" title="Show execution plan" href>
            Explain
          </a>
        </td>
        <td>
          <a v-on:click.prevent="explainAnalyze(query)" title="Show execution plan with analyze" href>
            Analyze
          </a>
        </td>
      </tr>
    </tbody>
  </table>
  <nav aria-label="Page navigation example">
    <ul class="pagination">
      <li class="page-item">
        <a class="page-link" aria-label="First" v-on:click.prevent="page = 1">
          <span aria-hidden="true">⏮</span>
        </a>
      </li>
      <li :class="['page-item', {'active': page_ == page - 1}]" v-for="page_ in pages">
        <a class="page-link" href v-on:click.prevent="page = page_ + 1">{{! page_ }}</a>
      </li>
      <li class="page-item">
        <a class="page-link" aria-label="Last" v-on:click.prevent="page = pages[pages.length - 1] + 1">
          <span aria-hidden="true">⏭</span>
        </a>
      </li>
    </ul>
  </nav>
  <div id="explainModal" class="modal modal-fullscreen" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Explained Execution Plan</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body d-flex flex-column p-0">
          <template v-if="plan">
            <pev2 :plan-source="plan" :plan-query="sql" :key="explainKey"></pev2>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>
<link href="/css/slowqueries/pev2.css" rel="stylesheet">
<script src="/js/moment.min.js"></script>
<script src="/js/moment-duration-format.js"></script>
<script src="/js/vue.min.js"></script>
<script src="/js/vue-router.min.js"></script>
<script src="/js/highlightjs/highlight.pack.js"></script>
<script src="/js/slowqueries/temboard.slowqueries.js"></script>
<script src="/js/slowqueries/pev2.umd.min.js"></script>
<script src="/js/monitoring/datemath.js"></script>
<script src="/js/monitoring/rangeutils.js"></script>
<script src="/js/daterangepicker.js"></script>
<script src="/js/monitoring/daterangepicker.vue.js"></script>
<script>
  var apiUrl = '/server/{{ instance.agent_address }}/{{ instance.agent_port }}/slowqueries.json';
  var explainUrl = '/proxy/{{ instance.agent_address }}/{{ instance.agent_port }}/slowqueries/explain';
</script>
{% end %}
